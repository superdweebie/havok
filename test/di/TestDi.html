<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Testing havok/di/Di</title>
        <script type="text/javascript" src="../testconfig.js"></script>
        <script type="text/javascript" src="../../../dojo/dojo.js"></script>
		<script type="text/javascript">
			require([
                'doh/main',
                'dojo/_base/lang',
                'dojo/when',
                'havok/di/Di',
                'havok/di/Proxy',
                'havok/test/di/asset/config',
                'dojo/domReady!'
            ],
            function(
                doh,
                lang,
                when,
                Di,
                Proxy,
                config
            ){
                doh.register("havok/test/di/TestDi", [

                    function configTest(doh){

                        var startingConfig = {
                            testButton: {
                                base: 'my/module',
                                params: {
                                    label: 'Test Button'
                                }
                            }
                        };

                        var customConfig = {
                            testButton: {
                                base: 'my/module',
                                params: {
                                    showLabel: false
                                }
                            }
                        };

                        var mergedConfig = {
                            testButton: {
                                base: 'my/module',
                                params: {
                                    label: 'Test Button',
                                    showLabel: false
                                }
                            }
                        }

                        var changedConfig = {
                            base: 'my/module',
                            params: {
                                label: 'changed'
                            }
                        };

                        var di = new Di(startingConfig);

                        doh.assertEqual(startingConfig, di.getConfig());

                        di.mergeConfig(customConfig);
                        doh.assertEqual(mergedConfig, di.getConfig());

                        doh.assertEqual(mergedConfig.testButton, di.getIdentifierConfig('testButton'));

                        di.setIdentifierConfig('testButton', changedConfig);
                        doh.assertEqual(changedConfig, di.getIdentifierConfig('testButton'));
                    },

                    function noConfigTest(){

                        var di = new Di();
                        var deferredTest = new doh.Deferred;
                        var zoo;

                        // get with no config - just module name
                        when(di.get('havok/test/di/asset/Zoo'), function(zoo){
                            doh.assertEqual('the havok zoo', zoo.name);
                            zoo.name = 'other zoo';

                            // get- should return cached Zoo cached with modified name
                            when(di.get('havok/test/di/asset/Zoo'), function(zoo){
                                doh.assertEqual('other zoo', zoo.name);

                                di.clearCache();

                                //should return new instance of Zoo - with original name
                                when(di.get('havok/test/di/asset/Zoo'), function(zoo){
                                    doh.assertEqual('the havok zoo', zoo.name);
                                    deferredTest.callback(true);
                                });
                            });
                        });

                        return deferredTest;
                    },

                    function noBaseTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('havok/test/di/asset/Penguin'), function(penguin){
                            doh.assertEqual('kate', penguin.name);
                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },


                    function baseSetTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithBase'), function(zoo){
                            doh.assertEqual('the havok zoo', zoo.name);
                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function identifierBaseTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooIdentifierBase'), function(zoo){
                            doh.assertEqual('the havok zoo', zoo.name);
                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function objectBaseTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('objectBase'), function(object){
                            doh.assertEqual('alan', object.name);
                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function paramsTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooParams'), function(zoo){
                            doh.assertEqual('Zoo with param', zoo.name);
                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function params2Test(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('foodsParams'), function(food){
                            doh.assertEqual('fish', food.penguin);
                            doh.assertEqual('beef', food.lion);
                            doh.assertEqual('grubs', food.meerkat);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function declareFalseTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooDeclareFalse'), function(zoo){
                            doh.assertEqual('Zoo instance', zoo.name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function declareTrueTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('ZooDeclareTrue'), function(Zoo){

                            var zoo = new Zoo;

                            doh.assertEqual('Zoo extended', zoo.name);
                            zoo.name = 'Zoo changed';

                            var zoo2 = new Zoo;
                            doh.assertEqual('Zoo changed', zoo.name);
                            doh.assertEqual('Zoo extended', zoo2.name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function cacheTrueTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooCacheTrue'), function(zoo){

                            doh.assertEqual('Zoo cache true', zoo.name);
                            zoo.name = 'Zoo changed';

                            when(di.get('zooCacheTrue'), function(cachedZoo){
                                doh.assertEqual('Zoo changed', cachedZoo.name);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function cacheFalseTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooCacheFalse'), function(zoo){

                            doh.assertEqual('Zoo cache false', zoo.name);
                            zoo.name = 'Zoo changed';

                            when(di.get('zooCacheFalse'), function(cachedZoo){
                                doh.assertEqual('Zoo cache false', cachedZoo.name);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function defineFalseTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooDefineFalse'), function(zoo){

                            doh.assertEqual('Zoo define false', zoo.name);

                            try {
                                require('zooDefineFalse');
                            } catch (e) {
                                doh.assertEqual('Error: undefinedModule', e);
                                deferredTest.callback(true);
                            }
                        });

                        return deferredTest;
                    },

                    function defineTrueTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooDefineTrue'), function(zoo){

                            doh.assertEqual('Zoo define true', zoo.name);

                            require(['zooDefineTrue'], function(zooDefined){
                                doh.assertEqual('Zoo define true', zooDefined.name);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function defineTrue2Test(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('foodsDefineTrue'), function(food){

                            doh.assertEqual('fish', food.penguin);
                            doh.assertEqual('beef', food.lion);
                            doh.assertEqual('grubs', food.meerkat);

                            require(['foodsDefineTrue'], function(foodDefined){

                                doh.assertEqual('fish', foodDefined.penguin);
                                doh.assertEqual('beef', foodDefined.lion);
                                doh.assertEqual('grubs', foodDefined.meerkat);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function declareAndDefineTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('ZooDeclareAndDefine'), function(){

                            require(['ZooDeclareAndDefine'], function(Zoo){

                                var zoo = new Zoo;

                                doh.assertEqual('Zoo declared and defined', zoo.name);
                                zoo.name = 'Zoo changed';

                                var zoo2 = new Zoo;
                                doh.assertEqual('Zoo changed', zoo.name);
                                doh.assertEqual('Zoo declared and defined', zoo2.name);

                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function getsTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithGets'), function(zoo){

                            doh.assertEqual('Zoo with gets', zoo.name);
                            doh.assertEqual('lucy', zoo.lion1.name);
                            doh.assertEqual('liz', zoo.lion2.name);
                            doh.assertEqual('toby', zoo.tiger.name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function getsArrayTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithGetsArray'), function(zoo){

                            doh.assertEqual('Zoo with gets array', zoo.name);
                            doh.assertEqual('lucy', zoo.cage[0].name);
                            doh.assertEqual('liz', zoo.cage[1].name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function nestedGetsConfigTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithNestedGetsConfig'), function(zoo){

                            doh.assertEqual('Zoo with nested gets config', zoo.name);
                            doh.assertEqual('tim', zoo.tiger.name);
                            doh.assertEqual('liz', zoo.cage[0].name);
                            doh.assertEqual('emma', zoo.cage[1].name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function proxyMethodTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.proxy('zooWithProxyMethods'), function(zooProxy){
                            doh.assertTrue(zooProxy.isInstanceOf(Proxy));
                            doh.assertEqual('Zoo with proxy', zooProxy.name);
                            zooProxy.listAnimals().then(function(names){
                                doh.assertEqual(['lucy', 'liz', 'toby'], names);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function proxiesTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithProxies'), function(zoo){

                            doh.assertTrue(lang.isArray(zoo.cage));

                            doh.assertTrue(zoo.cage[0].isInstanceOf(Proxy));
                            doh.assertEqual('liz', zoo.cage[0].name);

                            doh.assertTrue(zoo.cage[1].isInstanceOf(Proxy));
                            doh.assertEqual('emma', zoo.cage[1].name);

                            doh.assertTrue(zoo.tiger.isInstanceOf(Proxy));
                            doh.assertEqual('Josh', zoo.tiger.name);
                            zoo.tiger.makeSound().then(function(sound){
                                doh.assertEqual('roar', sound);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function spreadArrayTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithSpreadArray'), function(zoo){

                            doh.assertTrue(lang.isArray(zoo.animals));

                            doh.assertEqual('cobra', zoo.animals[0]);
                            doh.assertEqual('crocodile', zoo.animals[1]);
                            doh.assertEqual('lucy', zoo.animals[2].name);
                            doh.assertEqual('liz', zoo.animals[3].name);

                            doh.assertTrue(zoo.animals[4].isInstanceOf(Proxy));
                            doh.assertEqual('Josh', zoo.animals[4].name);
                            zoo.animals[4].makeSound().then(function(sound){
                                doh.assertEqual('roar', sound);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    }
                ]);

                doh.runOnLoad();
            });
		</script>
	</head>
	<body>
        <h1>Testing havok/di/Di</h1>
	</body>
</html>
