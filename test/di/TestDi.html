<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Testing havok/di/Di</title>
        <script type="text/javascript" src="../testconfig.js"></script>
        <script type="text/javascript" src="../../../dojo/dojo.js"></script>
		<script type="text/javascript">
			require([
                'doh/main',
                'dojo/_base/lang',
                'dojo/when',
                'havok/di/Di',
                'havok/di/Proxy',
                'havok/test/di/asset/config',
                'dojo/domReady!'
            ],
            function(
                doh,
                lang,
                when,
                Di,
                Proxy,
                config
            ){
                doh.register("havok/test/di/TestDi", [

                    function getsTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithGets'), function(zoo){

                            doh.assertEqual('Zoo with gets', zoo.name);
                            doh.assertEqual('lucy', zoo.lion1.name);
                            doh.assertEqual('liz', zoo.lion2.name);
                            doh.assertEqual('toby', zoo.tiger.name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function getsArrayTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithGetsArray'), function(zoo){

                            doh.assertEqual('Zoo with gets array', zoo.name);
                            doh.assertEqual('lucy', zoo.cage[0].name);
                            doh.assertEqual('liz', zoo.cage[1].name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function nestedGetsConfigTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithNestedGetsConfig'), function(zoo){

                            doh.assertEqual('Zoo with nested gets config', zoo.name);
                            doh.assertEqual('tim', zoo.tiger.name);
                            doh.assertEqual('liz', zoo.cage[0].name);
                            doh.assertEqual('emma', zoo.cage[1].name);

                            deferredTest.callback(true);
                        });

                        return deferredTest;
                    },

                    function proxyMethodTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.proxy('zooWithProxyMethods'), function(zooProxy){
                            doh.assertTrue(zooProxy.isInstanceOf(Proxy));
                            doh.assertEqual('Zoo with proxy', zooProxy.name);
                            zooProxy.listAnimals().then(function(names){
                                doh.assertEqual(['lucy', 'liz', 'toby'], names);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function proxiesTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithProxies'), function(zoo){

                            doh.assertTrue(lang.isArray(zoo.cage));

                            doh.assertTrue(zoo.cage[0].isInstanceOf(Proxy));
                            doh.assertEqual('liz', zoo.cage[0].name);

                            doh.assertTrue(zoo.cage[1].isInstanceOf(Proxy));
                            doh.assertEqual('emma', zoo.cage[1].name);

                            doh.assertTrue(zoo.tiger.isInstanceOf(Proxy));
                            doh.assertEqual('Josh', zoo.tiger.name);
                            zoo.tiger.makeSound().then(function(sound){
                                doh.assertEqual('roar', sound);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    },

                    function spreadArrayTest(){
                        var di = new Di(config.di);

                        var deferredTest = new doh.Deferred;

                        when(di.get('zooWithSpreadArray'), function(zoo){

                            doh.assertTrue(lang.isArray(zoo.animals));

                            doh.assertEqual('cobra', zoo.animals[0]);
                            doh.assertEqual('crocodile', zoo.animals[1]);
                            doh.assertEqual('lucy', zoo.animals[2].name);
                            doh.assertEqual('liz', zoo.animals[3].name);

                            doh.assertTrue(zoo.animals[4].isInstanceOf(Proxy));
                            doh.assertEqual('Josh', zoo.animals[4].name);
                            zoo.animals[4].makeSound().then(function(sound){
                                doh.assertEqual('roar', sound);
                                deferredTest.callback(true);
                            });
                        });

                        return deferredTest;
                    }
                ]);

                doh.runOnLoad();
            });
		</script>
	</head>
	<body>
        <h1>Testing havok/di/Di</h1>
	</body>
</html>
